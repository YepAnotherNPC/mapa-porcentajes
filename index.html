<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Mapa con porcentajes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Mapbox -->
  <link
    href="https://api.mapbox.com/mapbox-gl-js/v3.14.0/mapbox-gl.css"
    rel="stylesheet"
  />
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.14.0/mapbox-gl.js"></script>

  <style>
    body {
      margin: 0;
      padding: 0;
    }

    #map {
      width: 100%;
      height: 100vh;
    }

    /* ðŸ”µ FORMATO DEL PUNTO (IGUAL AL ORIGINAL) */
    .marker {
      width: 15px;
      height: 15px;
      border-radius: 15%;

      display: flex;
      align-items: center;
      justify-content: center;

      font-weight: bold;
      font-size: 12px;
      color: #000;

      border: 2px solid white;
      cursor: pointer;
      user-select: none;

      filter: saturate(180%);
    }

    .mapboxgl-popup-content {
      text-align: center;
      font-family: Arial, sans-serif;
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <script>
    /* ðŸ”‘ TOKEN MAPBOX */
    mapboxgl.accessToken =
      'pk.eyJ1IjoiZW1vcmVub2QiLCJhIjoiY21sNW9uZjdlMDRwazNkb2FzYXRibHhrbSJ9.Hod4AyKzJZmGdJyEL-7LOg';

    /* ðŸ“„ URL CSV DE GOOGLE SHEETS (PUBLICADO) */
    const SHEET_URL =
      'https://docs.google.com/spreadsheets/d/e/2PACX-1vQUdfpCVAWZcpeZRvZTsFCDK1vt3laquSH5fjirJv9_rAXAF1UDycHyUlbj43ZVPJYTBBFpNCKw_mAz/pub?gid=0&single=true&output=csv';

    /* ðŸŽ¨ COLOR PROGRESIVO (ROJO â†’ AMARILLO â†’ VERDE) */
    function getGradientColor(percent) {
      percent = Math.max(0, Math.min(100, percent));

      if (percent <= 50) {
        const ratio = percent / 50;
        const r = 255;
        const g = Math.round(50 + 205 * ratio);
        return `rgb(${r}, ${g}, 0)`;
      } else {
        const ratio = (percent - 50) / 50;
        const r = Math.round(255 * (1 - ratio));
        const g = 255;
        return `rgb(${r}, ${g}, 0)`;
      }
    }

    /* ðŸ“„ PARSE CSV (AUTO , o ;) */
    function parseCSV(text) {
      const lines = text.trim().split('\n');
      const separator = lines[0].includes(';') ? ';' : ',';
      const headers = lines.shift().split(separator);

      return lines.map(line => {
        const values = line.split(separator);
        const obj = {};
        headers.forEach((h, i) => {
          obj[h.trim()] = values[i]?.trim();
        });
        return obj;
      });
    }

    /* ðŸ—ºï¸ CREAR MAPA */
    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/light-v11',
      center: [-70.64, -33.45],
      zoom: 12
    });

    /* ðŸ“ CARGAR DATOS DESDE GOOGLE SHEETS */
    fetch(SHEET_URL)
      .then(res => res.text())
      .then(csv => {
        const data = parseCSV(csv);
        const bounds = new mapboxgl.LngLatBounds();

        data.forEach(p => {
          const percent = Number(p.percent);
          const lat = Number(p.lat);
          const lng = Number(p.lng);

          if (isNaN(percent) || isNaN(lat) || isNaN(lng)) return;

          const color = getGradientColor(percent);

          const el = document.createElement('div');
          el.className = 'marker';
          el.textContent = percent + '%';

          /* ðŸ”¥ APLICAR COLOR Y GLOW */
          el.style.backgroundColor = color;
          el.style.boxShadow = `
            0 0 6px ${color},
            0 0 12px ${color},
            0 0 20px ${color}
          `;

          new mapboxgl.Marker(el)
            .setLngLat([lng, lat])
            .setPopup(
              new mapboxgl.Popup({ offset: 25 }).setHTML(
                `<h3>${p.name}</h3><b>${percent}%</b>`
              )
            )
            .addTo(map);

          bounds.extend([lng, lat]);
        });

        map.fitBounds(bounds, {
          padding: 40,
          maxZoom: 14
        });
      })
      .catch(err => {
        console.error('Error cargando CSV:', err);
      });
  </script>
</body>

</html>
















